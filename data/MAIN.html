<!DOCTYPE html>
<html lang='zh-CN'>

<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel='stylesheet' type='text/css' href='bootstrap.min.css'>
    <link rel='stylesheet' type='text/css' href='toast.css'>
    <script src='jquery.slim.min.js'></script>
    <script src='bootstrap.bundle.min.js'></script>
    <script src='toast.js'></script>
    <title>eInk Demo</title>
</head>

<body onload='getData1()'>

    <div class='container'>

        <h2>WIFI配置&nbsp;<small style='font-size:0.9rem;'><span id='my_staNameIp'>获取中…
                    <!--返回STA名称和ip-->
                </span></small></h2>

        <form id='form_wifi' target='iframe_wifi'>
            <div class='form-group' id='wifi_type'>
                <label for="sel1">周边网络:</label>
                <select class="form-control" id="sel1">
                    <option>未扫描</option>
                </select>
            </div>

            <div class='form-group'>
                <label for='password'>WIFI密码:</label>
                <input type='text' class='form-control' name='password' autocomplete='off' placeholder='请输入'>
            </div>
            <button type='submit' class='btn btn-primary' onclick='saveConnect_wifi()'>保存并连接</button>
            <button type='button' class='btn btn-success' onclick='scan_wifi()'>扫描</button>
            <button type='button' class='btn btn-secondary' onclick='manual_wifi()'>手动</button>
            <span id='my_wifiReturnFormInfo'>
                <!-- 按下保存按钮后服务器返回的消息提示 -->
            </span>
        </form>

        <iframe name='iframe_wifi' style='display:none;'></iframe> <!-- 不跳转页面 -->

        <!-- <form id='form_clockCompensate' target='iframe_clockCompensate'>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">软件时钟补偿</span>
                </div>
                <div id='my_clockCompensateData' style='width:7.5em'>
                    <input type='text' class='form-control' name='ClockCompensate' placeholder='获取中' autocomplete='off'>
                </div>
            </div>
            <button type='submit' class="btn btn-primary btn-sm" onclick='clockCompensate_submit()'>保存</button>
            <a href='#zd2' class='btn btn-secondary btn-sm' data-toggle='collapse'>方法</a>
            <div id='zd2' class='collapse'>
                * 快加慢减 *<br>
                软件时钟补偿方法如下，单位：（ms/min）：<br>
                补:当前值+/-[误差的秒数÷(结束时间-开始时间)×1000]<br>
                如:480分钟快了50秒<br>
                则:当前值+50÷480×1000=当前值+104<br>
            </div>
        </form>
        <iframe name='iframe_clockCompensate' style='display:none;'></iframe>
        <hr /> -->

        <!-- <form id='form_clockJZJG' target='iframe_clockCalInterval'>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" >时钟校准间隔</span>
                        </div>
                        <div id='my_clockJZJG' style='width:7.5em'>
                            <input type='text'  class='form-control' name='ClockJZJG' placeholder='获取中' autocomplete='off'>
                        </div>
                    </div>
                    <button type='submit' class="btn btn-primary btn-sm" onclick='clockCalInverval_submit()'>保存</button>
                    <a href='#zd3' class='btn btn-secondary btn-sm' data-toggle='collapse'>说明</a>				
                    <div id='zd3' class='collapse'>
                        软件时钟<br>	
                        静默联网校准<br>			
                        若时钟芯片存在此设置无效
                    </div>
                </form>
                <iframe name='iframe_clockCalInterval' style='display:none;'></iframe>
                <hr/> -->

        <!-- <form id='form_setOutputPower' target='iframe_setOutputPower'>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" >发射功率dBm</span>
                        </div>
                    <div id='my_setOutputPower' style='width:7.5em'>
                        <input type='text'  class='form-control' name='SetOutputPower' placeholder='获取中' autocomplete='off'>
                    </div>
                    </div>
                    <button type='submit' class="btn btn-primary btn-sm" onclick='setOutputPower_submit()'>保存</button>	
                    <a href='#zd5' class='btn btn-secondary btn-sm' data-toggle='collapse'>说明</a>				
                    <div id='zd5' class='collapse'>
                        * 范围10-20.5，每级0.25 *<br>
                        如果由于信号噪声而遇到wifi连接问题<br>
                        可以尝试降低Tx功率，但最大范围也会减小<br>
                        重启生效<br>
                    </div>
                </form>
                <iframe name='iframe_setOutputPower' style='display:none;'></iframe>
                <hr/> -->

        <!-- 模态框底部 -->
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">关闭</button>
        </div>

    </div>
    </div>
    </div>

    <!-- 系统信息模态框 -->
    <div class="modal fade" id="Modal_info">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- 模态框头部 -->
                <div class="modal-header">
                    <h4 class="modal-title">ESP8266-12F</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- 模态框主体 -->
                <div class="modal-body" id='my_info'>
                    获取中…
                </div>


            </div>
        </div>
    </div>

    <br><br>
    <div class='row' style='text-align:center; font-size:0.8rem;'>
        <div class='col'>悬浮时钟，原作者连接 <a href='https://www.instructables.com/Hollow-Clock-4/'>Hollow Clock4</a> </div>
        <div class='col'>Updated by 小桦同同学 <a href='https://www.instructables.com/Hollow-Clock-4/'>Wifi 同步版</a> </div>
    </div>

    </div>

    <script>
        //吐司消息提示框
        $('body').tooltip({
            selector: '[data-toggle="tooltip"]'
        });
        function show_toast(str1, str2) {
            $.toast({
                title: str1,
                content: str2,
                type: 'info',
                delay: 2000
            });
        }
        function show_toast_noTime(str1, str2) {
            $.toast({
                title: str1,
                content: str2,
                type: 'info',
                delay: 0
            });
        }

        var timingGetVar2;
        function getData1() {
            setTimeout(function () { get_staNameIp(); }, 500); //获取stp和天气数据，仅一次
        }

        function getData2() {
            timingGetVar2 = setInterval(function () { get_staNameIp(); }, 3000); //获取stp和天气数据，循环获取
        }
        function stopgetData2() {
            clearInterval(timingGetVar2);  //停止获取stp和天气数据
        }
        
        //*****************************************	

        function saveConnect_wifi() //WIFI表单提交
        {
            var form = document.getElementById('form_wifi');
            // 将html表单转换为formData表单对象
            var formData = new FormData(form);
            // 创建ajax对象
            var xhr = new XMLHttpRequest();
            // 对ajax对象进行配置
            xhr.open('POST', '/Wifi');
            // 当发送跨域请求时，携带cookie信息
            xhr.withCredentials = true;
            // 发送请求并传递请求参数
            xhr.send(formData);
            // 监听服务器端给予的响应内容
            xhr.onload = function () {
                //console.log(xhr.responseText);
                if (xhr.responseText != "") {
                    wifi_xiaoxi = xhr.responseText;
                    web_message = "<div class='alert alert-success alert-dismissible fade show' style='margin:10px;'>";
                    // web_message += "<button type='button' class='close' data-dismiss='alert'>&times;</button>";
                    web_message += "<strong>" + wifi_xiaoxi + "</strong></div>";
                    document.getElementById('my_wifiReturnFormInfo').innerHTML = web_message;
                }
                getData2();
            }
        }

        function clockCompensate_submit() //时钟补偿值表单提交
        {
            var form = document.getElementById('form_clockCompensate');
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/ClockCompensate');
            xhr.withCredentials = true;
            xhr.send(formData);
            xhr.onload = function () {
                console.log(xhr.responseText);
                if (xhr.responseText != "") {
                    show_toast('时钟配置', xhr.responseText);
                }
                else show_toast('时钟配置', '返回为空');
            }
            get_clockCompensate();
        }

        function setOutputPower_submit() //发射功率表单提交
        {
            var form = document.getElementById('form_setOutputPower');
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/SetOutputPower');
            xhr.withCredentials = true;
            xhr.send(formData);
            xhr.onload = function () {
                console.log(xhr.responseText);
                if (xhr.responseText != "") {
                    show_toast('发射功率配置', xhr.responseText);
                }
                else show_toast('发射功率配置', '返回为空');
            }
            get_setOutputPower();
        }

        function clockCalInverval_submit() //时钟校准间隔表单提交
        {
            var form = document.getElementById('form_clockJZJG');
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/ClockJZJG');
            xhr.withCredentials = true;
            xhr.send(formData);
            xhr.onload = function () {
                console.log(xhr.responseText);
                if (xhr.responseText != "") {
                    show_toast('时钟校准间隔配置', xhr.responseText);
                }
                else show_toast('时钟校准间隔配置', '返回为空');
            }
            get_clockClockCalInterval();
        }

        function get_info()  //获取系统配置信息
        {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    document.getElementById('my_info').innerHTML = xhttp.responseText;
                }
            };
            xhttp.open('GET', '/Read_info', true);
            xhttp.send();
        }

        function get_clockCompensate()  //获取时间补偿值
        {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    document.getElementById('my_clockCompensateData').innerHTML = xhttp.responseText;
                }
            }
            xhttp.open('GET', '/Read_clockCompensate?t=' + Math.random(), true);
            xhttp.send();
        }

        function get_setOutputPower()  //获取发射功率
        {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    document.getElementById('my_setOutputPower').innerHTML = xhttp.responseText;
                }
            }
            xhttp.open('GET', '/Read_setOutputPower?t=' + Math.random(), true);
            xhttp.send();
        }

        function get_clockClockCalInterval()  //获取时钟校准间隔值
        {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    document.getElementById('my_clockJZJG').innerHTML = xhttp.responseText;
                }
            }
            xhttp.open('GET', '/Read_clockJZJG?t=' + Math.random(), true);
            xhttp.send();
        }

        function manual_wifi() {
            document.getElementById("wifi_type").innerHTML = "<label for='ssid'>WIFI名称:</label><input type='text' class='form-control' name='ssid' placeholder='请输入'>";
            document.getElementById('my_wifiReturnFormInfo').innerHTML = "";
        }
        function scan_wifi() {
            document.getElementById("wifi_type").innerHTML = "<label for='sel1'>周边网络:</label><select class='form-control' id='sel1'><option>扫描中</option></select>";

            var web_message = "<div class='alert alert-success alert-dismissible fade show' style='margin:10px;'>";
            // web_message += "<button type='button' class='close' data-dismiss='alert'>&times;</button>";
            web_message += "<strong>" + "WIFI扫描中" + "</strong></div>";
            document.getElementById('my_wifiReturnFormInfo').innerHTML = web_message;

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    document.getElementById('wifi_type').innerHTML = xhttp.responseText;

                    web_message = "<div class='alert alert-success alert-dismissible fade show' style='margin:10px;'>";
                    // web_message += "<button type='button' class='close' data-dismiss='alert'>&times;</button>";
                    web_message += "<strong>" + "扫描完毕" + "</strong></div>";
                    document.getElementById('my_wifiReturnFormInfo').innerHTML = web_message;
                }
            }
            xhttp.open('GET', '/Read_scanWifi', true);
            xhttp.send();
        }

        var old_xiaoxi;
        var xiaoxi_count = 0;
        function get_staNameIp()  //获取WIFI名称和IP地址
        {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    document.getElementById('my_staNameIp').innerHTML = xhttp.responseText;
                    if (old_xiaoxi == xhttp.responseText) {
                        xiaoxi_count++;
                        if (xiaoxi_count > 2) {
                            var str = xhttp.responseText;
                            var length = str.length;
                            var web_message;
                            //console.log(str);console.log(length);
                            if (str[length - 1] >= 0 && str[length - 1] <= 9) //判断最后一位为数字表示wifi连接成功
                            {
                                stopgetData2();
                                show_toast_noTime('WiFi配置', '连接成功');
                                web_message = "<div class='alert alert-success alert-dismissible fade show' style='margin:10px;'>";
                                // web_message += "<button type='button' class='close' data-dismiss='alert'>&times;</button>";
                                web_message += "<strong>" + "WiFi连接成功" + "</strong></div>";
                                document.getElementById('my_wifiReturnFormInfo').innerHTML = web_message;
                            }
                            else {
                                stopgetData2();
                                show_toast_noTime('WiFi配置', '连接失败');
                                web_message = "<div class='alert alert-danger alert-dismissible fade show' style='margin:10px;'>";
                                // web_message += "<button type='button' class='close' data-dismiss='alert'>&times;</button>";
                                web_message += "<strong>" + "WiFi连接失败" + "</strong></div>";
                                document.getElementById('my_wifiReturnFormInfo').innerHTML = web_message;
                                document.getElementById("my_staNameIp").innerHTML = "WiFi连接失败";
                            }
                        }
                    }
                    else xiaoxi_count = 0;
                    old_xiaoxi = xhttp.responseText;
                }
            }
            xhttp.open('GET', '/Read_staNameIp', true);
            xhttp.send();
        }

    </script>
</body>

</html>